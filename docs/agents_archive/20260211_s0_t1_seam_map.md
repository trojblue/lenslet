# S0 T1 Seam Map

Timestamp (UTC): `2026-02-11T04:21:23Z`  
Branch: `main`  
Plan ticket: `T1`

## Objective

Define extraction seams and extraction order for the five longest core files so upcoming refactor tickets can stay atomic and behavior-safe.

## Target File Inventory

| File | Current lines | Mapped tickets |
| --- | ---: | --- |
| `src/lenslet/server.py` | 2314 | `T3`, `T4a`, `T4b`, `T4c`, `T4d`, `T5`, `T6`, `T7`, `T8` |
| `src/lenslet/storage/table.py` | 1266 | `T9`, `T10`, `T11`, `T12` |
| `frontend/src/app/AppShell.tsx` | 2213 | `T13a`, `T13b`, `T13c`, `T13d`, `T14`, `T15` |
| `frontend/src/features/inspector/Inspector.tsx` | 1561 | `T16`, `T17`, `T18`, `T19` |
| `frontend/src/features/metrics/MetricsPanel.tsx` | 1017 | `T20`, `T21`, `T22`, `T23` |

## Per-File Seam Anchors

### `src/lenslet/server.py`

- Runtime seam (`T3`): `create_app` (`1778`), `create_app_from_datasets` (`1974`), `create_app_from_table` (`2117`), `create_app_from_storage` (`2167`).
- Common route seam (`T4a`): `_register_folder_route` (`642`), `_register_common_api_routes` (`1553`).
- Presence seam (`T4b`): `_register_presence_routes` (`1050`).
- Embeddings/views seam (`T4c`): `_register_embedding_routes` (`1446`), `_register_views_routes` (`1390`).
- Index/OG/media seam (`T4d`): `_register_index_routes` (`1308`), `_register_og_routes` (`1340`), `_thumb_response_async` (`1202`), `_file_response` (`1254`).
- Facade compatibility seam (`T5`): keep `HotpathTelemetry` (`427`), `_thumb_response_async`, `_file_response`, and `og` module exposure.

### `src/lenslet/storage/table.py`

- Schema/path seam (`T9`): `_resolve_source_column` (`240`), `_compute_s3_prefixes` (`267`), `_compute_local_prefix` (`314`), path/column helpers in `354-457`.
- Index seam (`T10`): `_build_indexes` (`527`) plus metric extraction helpers (`747`, `771`).
- Probe/media seam (`T11`): `_probe_remote_dimensions` (`989`), `_read_dimensions_from_bytes` (`1133`), `_read_dimensions_fast` (`1164`) and format readers (`1178-1206`).
- Facade seam (`T12`): preserve `TableStorage` constructor/public methods and module exports `load_parquet_table` (`1249`) and `load_parquet_schema` (`1259`).

### `frontend/src/app/AppShell.tsx`

- Data scope seam (`T13a`): folder/search/similarity data loading and derived pools around `341-476` (for example `refetch` and `poolItems`).
- Selection/viewer/compare seam (`T13b`): selection state and viewer/compare handlers around `1691-1745`.
- Presence/sync seam (`T13c`): presence reducers/transitions around `580-734` and associated effects.
- Mutation/actions seam (`T13d`): move/upload/view persistence actions around `1550-1670`.
- Selector/model seam (`T14`): filter and derived display helpers around `974-1156`.
- Render/effect optimization seam (`T15`): memo/effect-heavy orchestration across AppShell, with first optimization candidates in `394-475`, `735-1470`, and `1870+`.

### `frontend/src/features/inspector/Inspector.tsx`

- Model seam (`T16`): metadata normalization/flatten/diff helpers in file head (`normalizeMetadata`, `flattenMeta`, formatting helpers).
- Section seam (`T17`): `InspectorSection` (`299`) and section-specific UI blocks in `Inspector` render.
- Async workflow seam (`T18`): `fetchMetadata` (`602`), `fetchCompareMetadata` (`618`), `handleComparisonExport` (`895`).
- Render optimization seam (`T19`): metadata render memoization (`668-731`) and compare diff derivation (`compareDiff` at `933`).

### `frontend/src/features/metrics/MetricsPanel.tsx`

- Component seam (`T20`): `MetricsPanel` (`78`), `AttributesPanel` (`198`), `MetricRangePanel` (`507`), `MetricHistogramCard` (`593`).
- Histogram model seam (`T21`): `computeHistogramFromValues` (`886`) and adjacent numeric helpers.
- Interaction hook seam (`T22`): drag/input state management currently in `MetricHistogramCard` (`613+`).
- Optimization seam (`T23`): repeated histogram derivations (`602-638`) for population/filtered/selected values.

## Extraction Order

1. Lock backend seams first (`server.py` then `table.py`) so frontend work starts against stable API/runtime behavior.
2. Decompose `AppShell` by domain hooks (`T13a-d`) before optimization (`T14`, `T15`).
3. Decompose `Inspector`, then `Metrics`, preserving pure-model extraction before interaction optimization in both files.

## Anchors Added In-File

`S0/T1 seam anchors` comments were added near the top of all five target files to keep ticket mapping visible at edit time.
