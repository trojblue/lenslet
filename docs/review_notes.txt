Review notes for docs/20260123_collaboration_sync_plan.md

Overall
- Plan is solid but several tasks bundle multiple deliverables, and a few critical assumptions/risks (single-process server, file locking, log growth) are not surfaced.

Missing or under-scoped work
- Add a ticket to define/update the API contract (request/response schemas, headers, error shapes) in `docs/` and align frontend typing with it.
- Add a ticket to implement the persistence warning banner when `--no-write` is enabled (mentioned in Idempotence/Recovery but not in T7–T12).
- Add a ticket for snapshot/log compaction/rotation (log growth risk) and a max size/age policy.
- Add a ticket for workspace file locking or atomic write strategy to avoid corrupt snapshots/logs on crash (fsync/atomic rename).
- Add a ticket for multi-process guardrails (document and enforce single worker, or detect and warn) since in-memory authoritative state breaks with >1 worker.
- Add a ticket for event payload/version schema docs and backward compatibility for older clients.

Oversized or ambiguous tasks (split suggested)
- T6 (write-behind) combines log format, append, snapshot, replay, and scheduling. Split into: log append + event IDs, snapshot writer/rotation, startup replay/merge.
- T8 (SSE client) combines connection management, cache mutation, and metrics handling. Split into: client lifecycle/reconnect; per-event cache updates.
- T10 (conflict badge/actions) combines UI affordance + conflict rebase logic. Split into UI only vs reapply/resolve logic.
- T13 (reconnect + polling fallback + offline state) should split into heartbeat/keepalive, reconnect/backoff, polling fallback.

Unclear goals / acceptance details to tighten
- Define “version conflict” rules precisely for `PUT` vs `PATCH` (does PUT require `If-Match`? when is 409 returned?).
- Define presence model details: dedupe across tabs, client_id scope, heartbeat interval/TTL, and what counts as “viewing” vs “editing”.
- Specify event ordering guarantees and ring buffer size/time window so replay/Last-Event-ID expectations are testable.
- Clarify how `gallery_id` is computed for nested folders and symlinks; document canonicalization rules.

Validation gaps
- No explicit tests for snapshot+log replay correctness (including idempotent replays).
- No validation of SSE `Last-Event-ID` replay behavior under reconnect/packet loss.
- No tests for partial patch semantics (e.g., removing tag without affecting notes/star).
- No test for `--no-write` behavior and UI banner (once added).

Hidden dependencies and risks
- Uvicorn reload / multiple workers: in-memory authoritative state may diverge. Document or enforce single worker mode.
- File system permissions: write-behind assumes `.lenslet/` is writable; add explicit error surfacing and UI state when it isn’t.
- JSONL log growth and replay time may degrade startup; add compaction policy and metrics.
- SSE fanout may block if clients are slow; ensure non-blocking send or drop policy with metrics.

Suggested new tickets (concise)
- T16: API contract doc + frontend types aligned (error shapes, SSE payload schema).
- T17: No-write warning banner + server flag to surface persistence status.
- T18: Snapshot/log compaction + atomic writes.
- T19: Single-worker guardrail (warn on `--workers>1` or runtime check).
- T20: Replay/Last-Event-ID backend test coverage.
